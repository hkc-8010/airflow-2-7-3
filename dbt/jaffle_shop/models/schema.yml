version: 2

models:
  - name: customers
    description: This table has basic information about a customer, as well as some derived facts based on a customer's orders

    columns:
      - name: customer_id
        description: This is a unique identifier for a customer
        tests:
          - unique
          - not_null

      - name: first_name
        description: Customer's first name. PII.

      - name: last_name
        description: Customer's last name. PII.

      - name: first_order
        description: Date (UTC) of a customer's first order

      - name: most_recent_order
        description: Date (UTC) of a customer's most recent order

      - name: number_of_orders
        description: Count of the number of orders a customer has placed

      - name: total_order_amount
        description: Total value (AUD) of a customer's orders

  - name: orders
    description: This table has basic information about orders, as well as some derived facts based on payments

    columns:
      - name: order_id
        tests:
          - unique
          - not_null
        description: This is a unique identifier for an order

      - name: customer_id
        description: Foreign key to the customers table
        tests:
          - not_null
          - relationships:
              to: ref('customers')
              field: customer_id

      - name: order_date
        description: Date (UTC) that the order was placed

      - name: status
        description: '{{ doc("orders_status") }}'
        tests:
          - accepted_values:
              values: ['placed', 'shipped', 'completed', 'return_pending', 'returned']

      - name: amount
        description: Total amount (AUD) of the order
        tests:
          - not_null

      - name: credit_card_amount
        description: Amount of the order (AUD) paid for by credit card
        tests:
          - not_null

      - name: coupon_amount
        description: Amount of the order (AUD) paid for by coupon
        tests:
          - not_null

      - name: bank_transfer_amount
        description: Amount of the order (AUD) paid for by bank transfer
        tests:
          - not_null

      - name: gift_card_amount
        description: Amount of the order (AUD) paid for by gift card
        tests:
          - not_null

  - name: customer_analytics
    description: >
      Complex analytics model that performs comprehensive customer and order analysis.
      This model combines customer segmentation, order trends, and lifetime value analysis
      to provide deep insights into customer behavior patterns. Features advanced SQL
      with multiple CTEs, window functions, and statistical aggregations.
    
    columns:
      - name: order_month
        description: Month of the order activity (truncated to month)
        tests:
          - not_null

      - name: frequency_segment
        description: Customer frequency classification (High/Medium/Low Frequency, One Time)
        tests:
          - not_null
          - accepted_values:
              values: ['High Frequency', 'Medium Frequency', 'Low Frequency', 'One Time']

      - name: value_segment
        description: Customer value classification based on customer lifetime value
        tests:
          - not_null
          - accepted_values:
              values: ['High Value', 'Medium Value', 'Low Value', 'Minimal Value']

      - name: unique_customers
        description: Count of unique customers in this segment for the month
        tests:
          - not_null

      - name: total_orders
        description: Total number of orders in this segment for the month
        tests:
          - not_null

      - name: total_revenue
        description: Total revenue (AUD) generated by this segment for the month
        tests:
          - not_null

      - name: avg_order_value
        description: Average order value (AUD) for this segment in the month

      - name: median_order_value
        description: Median order value (AUD) for this segment in the month

      - name: avg_customer_lifespan_days
        description: Average number of days between first and most recent order for customers in this segment

      - name: revenue_share_by_segment
        description: Percentage of monthly revenue contributed by this segment
        tests:
          - not_null
